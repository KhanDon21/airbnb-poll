<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airbnb Poll</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2em auto; }
    h1 { text-align: center; }
    .option { margin: 1em 0; }
    .option button { margin-left: 1em; }
    .votes { font-weight: bold; color: #007BFF; margin-left: 0.5em; }
    #message { margin-top: 1em; font-weight: bold; color: green; }
  </style>
</head>
<body>

  <h1>Which Airbnb do you prefer?</h1>
  <div id="poll"></div>
  <div id="message"></div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbx34w-Q8dqXZMwPadNOtMbEEZJBNaTo5bCGHDXNK9GCT9Tijl7AX6t6J2ZkLrS3dql78g/exec';

    // Define options with description and link
    const options = [
      { id: 'meadow', name: 'Meadow Mountain', link: 'https://www.airbnb.com/rooms/1280774680100631603?adults=13&check_in=2025-11-20&check_out=2025-11-24&wishlist_item_id=11005211931263', price: '$211/person' },
      { id: 'chalet', name: 'Spacious Chalet', link: 'https://www.airbnb.com/rooms/636207401490601720?adults=12&check_in=2025-11-20&check_out=2025-11-24&wishlist_item_id=11005231578469', price: '$308/person' },
      { id: 'duplex', name: 'Private Duplex', link: 'https://www.airbnb.com/rooms/48396425?adults=12&check_in=2025-11-20&check_out=2025-11-24', price: '$298/person' },
      { id: 'creekside', name: 'Creekside in the Pines', link: 'https://www.airbnb.com/rooms/681178880899806223?adults=12&check_in=2025-11-20&check_out=2025-11-24', price: '$353/person' },
      { id: 'rustic', name: 'Luxury Rustic Home', link: 'https://www.airbnb.com/rooms/51146290?adults=12&check_in=2025-11-20&check_out=2025-11-24', price: '$396/person' }
    ];

    const pollDiv = document.getElementById('poll');
    const messageDiv = document.getElementById('message');

    // Fetch and display current vote totals
    async function loadTotals() {
      try {
        const res = await fetch(`${API_BASE}?action=getTotals`);
        const totals = await res.json();

        pollDiv.innerHTML = '';

        options.forEach(opt => {
          const votes = totals[opt.id] || 0;
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option';
          optionDiv.innerHTML = `
            <a href="${opt.link}" target="_blank" rel="noopener noreferrer">${opt.name}</a> - ${opt.price}
            <button data-id="${opt.id}">Vote</button>
            <span class="votes">Votes: <span id="votes-${opt.id}">${votes}</span></span>
          `;
          pollDiv.appendChild(optionDiv);
        });

        // Attach vote button handlers
        document.querySelectorAll('button[data-id]').forEach(btn => {
          btn.onclick = () => vote(btn.getAttribute('data-id'));
        });

      } catch (err) {
        pollDiv.textContent = 'Failed to load poll data.';
        console.error(err);
      }
    }

    // Send vote via GET request
    async function vote(optionId) {
      messageDiv.textContent = 'Submitting your vote...';

      try {
        const res = await fetch(`${API_BASE}?action=vote&option=${encodeURIComponent(optionId)}`);
        const data = await res.json();

        if(data.status === 'ok'){
          messageDiv.textContent = 'Thank you for voting!';
          // Update vote count immediately
          const votesSpan = document.getElementById(`votes-${optionId}`);
          votesSpan.textContent = (parseInt(votesSpan.textContent) || 0) + 1;
        } else if(data.error) {
          messageDiv.textContent = 'Error: ' + data.error;
        } else {
          messageDiv.textContent = 'Unknown error occurred.';
        }

      } catch (err) {
        messageDiv.textContent = 'Network or server error.';
        console.error(err);
      }
    }

    // Initial load
    loadTotals();
  </script>

</body>
</html>
